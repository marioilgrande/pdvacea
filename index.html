<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Portale Inserimento Contratti ACEA</title>
  <style>
    :root{
      --acea-green:#0ABAB5;
      --acea-green-dark:#089f99;
      --bg-light:#f4f6f8;
      --card:#ffffff;
      --text:#444;
      --muted:#778;
      --border:#e5e7eb;
      --danger:#dc3545;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:20px; background:var(--bg-light);
      font-family: 'Segoe UI', system-ui, -apple-system, Roboto, Arial, sans-serif;
      display:flex; justify-content:center;
    }
    .container{
      position:relative; width:100%; max-width: 1000px;
      background:var(--card); border-radius:14px;
      box-shadow:0 8px 24px rgba(0,0,0,.08);
      padding:72px 28px 28px;
    }
    .header{
      position:absolute; inset:0 0 auto 0; height:56px;
      background: linear-gradient(90deg, var(--acea-green) 0%, #14d0ca 50%, var(--acea-green) 100%);
      border-top-left-radius:14px; border-top-right-radius:14px;
    }
    .title{
      position:absolute; top:8px; left:20px; right:20px; height:40px;
      display:flex; align-items:center; justify-content:space-between; color:#fff;
      font-weight:600; gap:10px;
    }
    .title small{ opacity:.9; font-weight:500 }
    .title-right{ display:flex; align-items:center; gap:8px; }
    .link-btn{
      background:transparent; color:#fff; border:1px solid rgba(255,255,255,.4);
      border-radius:8px; padding:6px 10px; cursor:pointer; font-size:.9rem;
    }
    .link-btn:hover{ background: rgba(255,255,255,.15); }
    #saveStatus{ font-size:.85rem; opacity:.9 }

    .progress-wrap{
      position:absolute; top:56px; left:0; width:100%; height:6px;
      background:var(--border); overflow:hidden; border-bottom:1px solid #ddd;
    }
    .progress{ height:100%; width:33.333%; background:var(--acea-green); transition: width .25s ease }

    h2{
      margin:0 0 14px; color:var(--acea-green);
      font-size:1.35rem; border-bottom:2px solid var(--acea-green); padding-bottom:6px;
    }
    p.help{ margin:0 0 18px; color:var(--muted); font-size:.95rem }

    .section{ display:none; }
    .section.active{ display:block; }

    .grid{ display:grid; gap:14px; }
    @media (min-width: 900px){ .grid.cols-2{ grid-template-columns: 1fr 1fr; } }

    .form-group{
      display:flex; flex-direction:column;
      background:#fff; border:1px solid var(--border); border-radius:10px;
      padding:10px 12px;
    }
    .form-group.full{ grid-column: 1 / -1; }
    .form-group label{ font-size:.92rem; color:#555; margin-bottom:6px; font-weight:600 }
    .form-group input, .form-group select{
      width:100%; padding:12px; border:1px solid #e3e5e8; border-radius:8px; font-size:1rem; background:#fff;
    }
    .form-group input:focus, .form-group select:focus{
      outline: none; border-color: var(--acea-green); box-shadow: 0 0 0 3px rgba(10,186,181,.12);
    }
    .hidden{ display:none !important; }

    .buttons{ margin-top:18px; display:flex; flex-wrap:wrap; gap:10px; justify-content:flex-end; }
    .btn{
      border:none; border-radius:10px; padding:14px 18px; font-size:1rem;
      color:#fff; cursor:pointer; transition: transform .05s ease, background .2s ease;
      min-width: 160px; text-align:center;
    }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{ background:var(--acea-green); }
    .btn-primary:hover{ background:var(--acea-green-dark); }
    .btn-secondary{ background:#6c757d; }
    .btn-secondary:hover{ background:#5a6268; }
    .btn-danger{ background:var(--danger); }
    .btn-danger:hover{ filter:brightness(.95); }

    @media (max-width:768px){
      body{ padding:10px; }
      .container{ padding:78px 16px 16px; border-radius:12px; }
      .buttons{ flex-direction:column; }
      .btn{ width:100%; min-width:unset; }
    }
    .hint{ font-size:.85rem; color:#667; margin-top:4px }

    /* ===== Modal Storico ===== */
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.4); padding:20px; z-index:1000; }
    .modal.show{ display:flex; }
    .modal-card{ background:#fff; border-radius:12px; width:100%; max-width:1000px; max-height:85vh; display:flex; flex-direction:column; overflow:hidden; }
    .modal-header, .modal-footer{ padding:12px 16px; background:#f7f9fa; border-bottom:1px solid #e5e7eb; }
    .modal-footer{ border-top:1px solid #e5e7eb; border-bottom:none; display:flex; gap:8px; justify-content:flex-end; }
    .modal-body{ padding:14px 16px; overflow:auto; }
    .modal-title{ font-weight:700; color:#333 }
    .close-x{ background:transparent; border:none; font-size:20px; cursor:pointer; }
    .toolbar{ display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px; }
    .toolbar input{ padding:10px; border:1px solid #e3e5e8; border-radius:8px; min-width:220px; }
    table{ width:100%; border-collapse:collapse; }
    thead th{ position:sticky; top:0; background:#eef4f5; color:#333; text-align:left; padding:10px; border-bottom:1px solid #dfe7e9; font-size:.92rem; }
    tbody td{ padding:10px; border-bottom:1px solid #f0f2f4; vertical-align:top; font-size:.93rem; }
    .td-actions{ display:flex; gap:6px; flex-wrap:wrap; }
    .badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:.8rem; background:#e8faf9; color:#077f7b; border:1px solid #c7efed; }
    .muted{ color:#666; font-size:.88rem; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header"></div>
    <div class="title">
      <div>Portale Inserimento Contratti ACEA</div>
      <div class="title-right">
        <small id="saveStatus">Bozza non salvata</small>
        <button type="button" class="link-btn" id="btnSaveDraft">üíæ Salva bozza</button>
        <button type="button" class="link-btn" id="btnClearDraft">üóëÔ∏è Cancella</button>
        <button type="button" class="link-btn" id="btnOpenHistory">üìÅ Storico <span id="historyCount" class="badge">0</span></button>
      </div>
    </div>
    <div class="progress-wrap"><div class="progress" id="progressBar"></div></div>

    <form id="wizardForm" onsubmit="return false;">

      <!-- ========== 1) ANAGRAFICA ========== -->
      <div class="section active" id="section-anagrafica">
        <h2>Anagrafica</h2>
        <p class="help">Compila i dati anagrafici del cliente. Se selezioni <b>Business</b>, compariranno i campi aziendali.</p>

        <div class="grid cols-2">
          <div class="form-group full">
            <label for="tipoCliente">Tipo Cliente</label>
            <select id="tipoCliente" required>
              <option value="" disabled selected>-- Seleziona --</option>
              <option value="privato">Privato</option>
              <option value="business">Business</option>
            </select>
          </div>

          <div class="form-group" id="group-nome">
            <label id="label-nome" for="nome">Nome e Cognome</label>
            <input type="text" id="nome" required>
          </div>

          <div class="form-group hidden" id="group-azienda">
            <label for="azienda">Ragione Sociale</label>
            <input type="text" id="azienda" required>
          </div>

          <div class="form-group" id="group-codice">
            <label id="label-codice" for="codice">Codice Fiscale</label>
            <input type="text" id="codice" required maxlength="16">
          </div>

          <div class="form-group hidden" id="group-legaleRapp">
            <label for="legaleRapp">Legale Rappresentante</label>
            <input type="text" id="legaleRapp" required>
          </div>

          <div class="form-group hidden" id="group-codiceLegale">
            <label for="codiceLegale">CF Legale Rappresentante</label>
            <input type="text" id="codiceLegale" required maxlength="16">
          </div>

          <div class="form-group">
            <label for="dataNascita">Data di Nascita</label>
            <input type="date" id="dataNascita" required>
          </div>

          <div class="form-group">
            <label for="luogoNascita">Luogo di Nascita</label>
            <input type="text" id="luogoNascita" required>
          </div>

          <div class="form-group full">
            <label for="indirizzo">Indirizzo</label>
            <input type="text" id="indirizzo" required>
          </div>

          <div class="form-group">
            <label for="telefono">Telefono</label>
            <input type="tel" id="telefono" required>
          </div>

          <div class="form-group">
            <label for="mail">Mail</label>
            <input type="email" id="mail" required>
          </div>

          <div class="form-group">
            <label for="tipoDoc">Documento</label>
            <select id="tipoDoc" required>
              <option value="" disabled selected>-- Seleziona --</option>
              <option>Carta d'identit√†</option>
              <option>Patente</option>
              <option>Passaporto</option>
            </select>
          </div>

          <div class="form-group">
            <label for="numeroDoc">Numero Documento</label>
            <input type="text" id="numeroDoc" required>
          </div>

          <div class="form-group">
            <label for="dataRilascio">Data Rilascio</label>
            <input type="date" id="dataRilascio" required>
          </div>

          <div class="form-group">
            <label for="dataScadenza">Data Scadenza</label>
            <input type="date" id="dataScadenza" required>
          </div>

          <div class="form-group full">
            <label for="rilasciatoDa">Rilasciato da</label>
            <input type="text" id="rilasciatoDa" required>
          </div>
        </div>

        <div class="buttons">
          <button type="button" class="btn btn-primary" id="next1">Avanti</button>
        </div>
      </div>

      <!-- ========== 2) FORNITURA ========== -->
      <div class="section" id="section-fornitura">
        <h2>Fornitura</h2>
        <p class="help">Indica i dettagli della fornitura e dell‚Äôoperazione.</p>

        <div class="grid cols-2">
          <div class="form-group full">
            <label for="useSameAddress">Stesso indirizzo Anagrafica?</label>
            <select id="useSameAddress" required>
              <option value="" disabled selected>-- Seleziona --</option>
              <option value="same">Usa indirizzo anagrafica</option>
              <option value="new">Inserisci nuovo indirizzo</option>
            </select>
          </div>

          <div class="form-group full hidden" id="group-indirizzoNew">
            <label for="indirizzoForn">Indirizzo Fornitura</label>
            <input type="text" id="indirizzoForn" required>
          </div>

          <div class="form-group full">
            <label for="tipoOp">Tipo Operazione</label>
            <select id="tipoOp" required>
              <option value="" disabled selected>-- Seleziona --</option>
              <option value="SWITCH_LUCE">SWITCH LUCE</option>
              <option value="SWITCH_GAS">SWITCH GAS</option>
              <option value="SWITCH_DUAL">SWITCH DUAL</option>
              <option value="SUBENTRO_LUCE">SUBENTRO LUCE</option>
              <option value="SUBENTRO_GAS_A01">SUBENTRO GAS A01</option>
              <option value="SUBENTRO_DUAL_LUCE_A01">SUBENTRO DUAL LUCE &gt; A01</option>
              <option value="SUBENTRO_GAS_A40">SUBENTRO GAS A40</option>
              <option value="SWITCH_VOLTURA_LUCE">SWITCH CON VOLTURA LUCE</option>
            </select>
          </div>

          <div class="form-group hidden" id="group-pod">
            <label for="pod">POD (luce)</label>
            <input type="text" id="pod" required>
          </div>

          <div class="form-group hidden" id="group-pdr">
            <label for="pdr">PDR (gas)</label>
            <input type="text" id="pdr" required>
          </div>

          <div class="form-group hidden" id="group-fornLuce">
            <label for="fornitoreUscenteLuce">Fornitore Uscente Luce</label>
            <input type="text" id="fornitoreUscenteLuce" required>
          </div>

          <div class="form-group hidden" id="group-fornGas">
            <label for="fornitoreUscenteGas">Fornitore Uscente Gas</label>
            <input type="text" id="fornitoreUscenteGas" required>
          </div>

          <div class="form-group hidden" id="group-matricola">
            <label for="matricola">Matricola</label>
            <input type="text" id="matricola" required>
          </div>

          <div class="form-group hidden" id="group-titoloOcc">
            <label for="titoloOcc">Titolo Occupazionale</label>
            <select id="titoloOcc" required>
              <option value="" disabled selected>-- Seleziona --</option>
              <option>Proprietario</option>
              <option>Locazione</option>
              <option>Altro</option>
            </select>
          </div>

          <div class="form-group hidden" id="group-dataPossesso">
            <label for="dataPossesso">Data Possesso</label>
            <input type="date" id="dataPossesso" required>
          </div>

          <div class="form-group full hidden" id="group-consumoAnnuale">
            <label for="consumoAnnuale">Consumo Annuale (SWITCH GAS)</label>
            <input type="number" id="consumoAnnuale" required>
          </div>

          <!-- Offerte dinamiche -->
          <div class="form-group hidden" id="group-offertaPrivatoLuce">
            <label for="offertaPrivatoLuce">Offerta Luce (Privato)</label>
            <select id="offertaPrivatoLuce" required>
              <option value="" disabled selected>-- Seleziona --</option>
              <option>SPRINT LUCE</option>
              <option>FLEX LUCE</option>
              <option>FIX LUCE</option>
            </select>
          </div>

          <div class="form-group hidden" id="group-offertaPrivatoGas">
            <label for="offertaPrivatoGas">Offerta Gas (Privato)</label>
            <select id="offertaPrivatoGas" required>
              <option value="" disabled selected>-- Seleziona --</option>
              <option>SPRINT GAS</option>
              <option>FLEX GAS</option>
              <option>FIX GAS</option>
            </select>
          </div>

          <div class="form-group hidden" id="group-offertaBusLuce">
            <label for="offertaBusLuce">Offerta Luce (Business)</label>
            <select id="offertaBusLuce" required>
              <option value="" disabled selected>-- Seleziona --</option>
              <option>SPRINT LUCE</option>
            </select>
          </div>

          <div class="form-group hidden" id="group-offertaBusGas">
            <label for="offertaBusGas">Offerta Gas (Business)</label>
            <select id="offertaBusGas" required>
              <option value="" disabled selected>-- Seleziona --</option>
              <option>SPRINT GAS</option>
            </select>
          </div>
        </div>

        <div class="buttons">
          <button type="button" class="btn btn-secondary" id="back2">Indietro</button>
          <button type="button" class="btn btn-primary" id="next2">Avanti</button>
        </div>
      </div>

      <!-- ========== 3) CHIUSURA ========== -->
      <div class="section" id="section-chiusura">
        <h2>Chiusura e Invio Contratto</h2>
        <p class="help">Scegli il metodo di pagamento e invia i dati tramite WhatsApp o Mail.</p>

        <div class="grid cols-2">
          <div class="form-group full">
            <label for="metodoPag">Metodo di Pagamento</label>
            <select id="metodoPag" required>
              <option value="" disabled selected>-- Seleziona --</option>
              <option value="IBAN">IBAN</option>
              <option value="BOLLETTINO">BOLLETTINO</option>
            </select>
          </div>

          <div class="form-group full hidden" id="group-iban">
            <label for="iban">IBAN</label>
            <input type="text" id="iban" required placeholder="IT00 X 0000 0000 0000 0000 0000 000">
            <span class="hint">Richiesto solo se selezioni ‚ÄúIBAN‚Äù.</span>
          </div>
        </div>

        <div class="buttons" style="gap:12px">
          <button type="button" class="btn btn-secondary" id="back3">Indietro</button>
          <button type="button" class="btn btn-primary" id="btnSendWhatsApp">Invia via WhatsApp</button>
          <button type="button" class="btn btn-primary" id="btnSendMail">Invia via Mail</button>
        </div>
      </div>

    </form>
  </div>

  <!-- ===== Modal Storico Pratiche ===== -->
  <div class="modal" id="historyModal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-header" style="display:flex;justify-content:space-between;align-items:center;">
        <div class="modal-title">üìÅ Storico pratiche (locale)</div>
        <button class="close-x" id="btnCloseHistory" aria-label="Chiudi">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="toolbar">
          <input type="search" id="historySearch" placeholder="Cerca per nome / ragione sociale, operazione, indirizzo..." />
          <button class="btn btn-primary" id="btnExportCSV" type="button">‚¨áÔ∏è Esporta CSV</button>
          <button class="btn btn-danger" id="btnClearHistory" type="button">üóëÔ∏è Svuota archivio</button>
          <span class="muted" id="historyHint"></span>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th style="min-width:130px;">Data</th>
                <th style="min-width:220px;">Cliente</th>
                <th style="min-width:160px;">Operazione</th>
                <th style="min-width:240px;">Indirizzo fornitura</th>
                <th style="min-width:110px;">Canale</th>
                <th>Azioni</th>
              </tr>
            </thead>
            <tbody id="historyTbody"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button class="link-btn" id="btnCloseBottom" type="button">Chiudi</button>
      </div>
    </div>
  </div>

  <script>
    /* ====================== UTIL DI VISIBILIT√Ä ======================= */
    function setGroupVisibility(groupId, visible){
      const el = document.getElementById(groupId);
      if(!el) return;
      el.classList.toggle('hidden', !visible);
      el.querySelectorAll('input,select,textarea').forEach(ctrl=>{
        ctrl.disabled = !visible;
        if(!visible){
          if(ctrl.tagName === 'SELECT'){ ctrl.selectedIndex = 0; }
          else { ctrl.value = ''; }
        } else if(ctrl.id === 'dataPossesso' && !ctrl.value){
          ctrl.valueAsDate = new Date();
        }
      });
    }

    /* ====================== NAV/PROGRESS ======================= */
    const sections = [...document.querySelectorAll('.section')];
    const progress = document.getElementById('progressBar');
    const PROG = ['33.333%','66.666%','100%'];
    const show = i => {
      sections.forEach((s, idx) => s.classList.toggle('active', idx === i));
      progress.style.width = PROG[i] || '33.333%';
      currentStep = i;
      window.scrollTo({ top:0, behavior:'smooth' });
    };
    let currentStep = 0;

    /* ====================== VALIDAZIONE ======================= */
    function validateSection(sectionId){
      const container = document.getElementById(sectionId);
      const fields = container.querySelectorAll('.form-group:not(.hidden) input, .form-group:not(.hidden) select, .form-group:not(.hidden) textarea');
      for(const f of fields){
        if(f.disabled) continue;
        const isEmpty = (f.tagName === 'SELECT')
          ? (f.value === '' || f.selectedIndex === 0)
          : (f.value.trim() === '');
        if(isEmpty){
          const label = (f.closest('.form-group')?.querySelector('label')?.innerText || f.id);
          alert(`Compila il campo: ${label}`);
          f.focus();
          return false;
        }
      }
      return true;
    }
    function validateAll(){
      return validateSection('section-anagrafica') &&
             validateSection('section-fornitura') &&
             validateSection('section-chiusura');
    }

    /* ====================== RACCOLTA MESSAGGIO ======================= */
    function collectVisibleLabeledData(){
      const order = [
        { id:'section-anagrafica', title:'ANAGRAFICA' },
        { id:'section-fornitura',  title:'FORNITURA'  },
        { id:'section-chiusura',   title:'CHIUSURA'   },
      ];
      const blocks = [];
      order.forEach(sec => {
        const groups = document.querySelectorAll(`#${sec.id} .form-group:not(.hidden)`);
        const lines = [];
        groups.forEach(g => {
          const labelEl = g.querySelector('label');
          const ctrl = g.querySelector('input,select,textarea');
          if(!ctrl) return;
          let value = '';
          if(ctrl.tagName === 'SELECT'){
            const opt = ctrl.options[ctrl.selectedIndex];
            value = opt ? opt.text : '';
          }else{
            value = ctrl.value;
          }
          const lab = labelEl ? labelEl.innerText : (ctrl.id || 'Campo');
          if(value !== '') lines.push(`${lab}: ${value}`);
        });

        // Indirizzo fornitura risolto
        if(sec.id === 'section-fornitura'){
          const same = document.getElementById('useSameAddress').value === 'same';
          const indAna = document.getElementById('indirizzo').value;
          const indForn = document.getElementById('indirizzoForn').value;
          const alreadyHasForn = lines.some(l => l.startsWith('Indirizzo Fornitura:'));
          const valueToUse = same ? indAna : indForn;
          if(valueToUse && !alreadyHasForn){
            lines.push(`Indirizzo Fornitura: ${valueToUse}`);
          }
        }

        if(lines.length) blocks.push(`‚Äî ${sec.title} ‚Äî\n${lines.join('\n')}`);
      });
      return blocks.join('\n\n');
    }
    function buildMessage(){
      const body = collectVisibleLabeledData();
      return `Ciao!\nTi chiedo di inserire questa pratica e darmi conferma inserimento:\n\n${body}\n\nGrazie per il supporto`;
    }
    function resolvedFornituraAddress(){
      const same = document.getElementById('useSameAddress').value === 'same';
      return same ? document.getElementById('indirizzo').value : document.getElementById('indirizzoForn').value;
    }

    /* ====================== NAV BUTTONS ======================= */
    document.getElementById('next1').onclick = () => { if(validateSection('section-anagrafica')) show(1); };
    document.getElementById('back2').onclick = () => show(0);
    document.getElementById('next2').onclick = () => { if(validateSection('section-fornitura')) show(2); };
    document.getElementById('back3').onclick = () => show(1);

    /* ====================== LOGICHE DINAMICHE ======================= */
    document.getElementById('tipoCliente').addEventListener('change', e => {
      const priv = e.target.value === 'privato';
      setGroupVisibility('group-nome', priv);
      setGroupVisibility('group-azienda', !priv);
      setGroupVisibility('group-legaleRapp', !priv);
      setGroupVisibility('group-codiceLegale', !priv);
      document.getElementById('label-nome').textContent = priv ? 'Nome e Cognome' : 'Ragione Sociale';
      document.getElementById('label-codice').textContent = priv ? 'Codice Fiscale' : 'Partita IVA';
    });
    document.getElementById('useSameAddress').addEventListener('change', e => {
      setGroupVisibility('group-indirizzoNew', e.target.value === 'new');
    });
    document.getElementById('tipoOp').addEventListener('change', function(){
      const v = this.value;
      const priv = document.getElementById('tipoCliente').value === 'privato';
      const isDual = v.includes('DUAL');
      const isSwitch = v.startsWith('SWITCH');
      const isLuceOnly = v.includes('LUCE') && !isDual;
      const isGasOnly  = v.includes('GAS')  && !isDual;
      const isSubGas   = v==='SUBENTRO_GAS_A01' || v==='SUBENTRO_GAS_A40';
      const isSubOrVolt= v.startsWith('SUBENTRO') || v==='SWITCH_VOLTURA_LUCE';

      setGroupVisibility('group-pod', (isLuceOnly || isDual));
      setGroupVisibility('group-pdr', (isGasOnly  || isDual));
      setGroupVisibility('group-fornLuce', (isSwitch && (isLuceOnly || isDual)));
      setGroupVisibility('group-fornGas',  (isSwitch && (isGasOnly  || isDual)));
      setGroupVisibility('group-matricola', isSubGas);
      setGroupVisibility('group-titoloOcc', isSubOrVolt);
      setGroupVisibility('group-dataPossesso', isSubOrVolt);
      setGroupVisibility('group-consumoAnnuale', v==='SWITCH_GAS');

      setGroupVisibility('group-offertaPrivatoLuce',  priv && (isLuceOnly || isDual));
      setGroupVisibility('group-offertaPrivatoGas',   priv && (isGasOnly  || isDual));
      setGroupVisibility('group-offertaBusLuce',     !priv && (isLuceOnly || isDual));
      setGroupVisibility('group-offertaBusGas',      !priv && (isGasOnly  || isDual));
    });
    document.getElementById('metodoPag').addEventListener('change', e => {
      setGroupVisibility('group-iban', e.target.value === 'IBAN');
    });
    const poss = document.getElementById('dataPossesso');
    if(poss) poss.valueAsDate = new Date();

    /* ====================== SALVA BOZZA ======================= */
    const DRAFT_KEY = 'acea_portale_bozza_v1';
    const saveStatus = document.getElementById('saveStatus');
    function saveDraft(){
      const data = {};
      document.querySelectorAll('#wizardForm input, #wizardForm select, #wizardForm textarea').forEach(el=>{
        data[el.id] = el.value;
      });
      localStorage.setItem(DRAFT_KEY, JSON.stringify(data));
      const now = new Date();
      const hh = String(now.getHours()).padStart(2,'0');
      const mm = String(now.getMinutes()).padStart(2,'0');
      saveStatus.textContent = `Bozza salvata alle ${hh}:${mm}`;
    }
    function loadDraftObj(obj){
      // set principali prima
      ['tipoCliente','useSameAddress','tipoOp','metodoPag'].forEach(id=>{
        if(obj[id] !== undefined && document.getElementById(id)){
          document.getElementById(id).value = obj[id];
        }
      });
      ['tipoCliente','useSameAddress','tipoOp','metodoPag'].forEach(id=>{
        const el = document.getElementById(id);
        if(el){ el.dispatchEvent(new Event('change')); }
      });
      // poi tutti gli altri
      Object.keys(obj).forEach(id=>{
        if(document.getElementById(id)){
          document.getElementById(id).value = obj[id];
        }
      });
    }
    function loadDraft(){
      const raw = localStorage.getItem(DRAFT_KEY);
      if(!raw) return;
      try{
        loadDraftObj(JSON.parse(raw));
        saveStatus.textContent = 'Bozza caricata';
      }catch(e){ console.warn('Errore caricamento bozza', e); }
    }
    function clearDraft(){
      localStorage.removeItem(DRAFT_KEY);
      saveStatus.textContent = 'Bozza cancellata';
    }
    document.getElementById('wizardForm').addEventListener('input', saveDraft);
    document.getElementById('wizardForm').addEventListener('change', saveDraft);
    document.getElementById('btnSaveDraft').addEventListener('click', saveDraft);
    document.getElementById('btnClearDraft').addEventListener('click', ()=>{
      clearDraft();
      alert('Bozza cancellata. (I dati a video restano finch√© non ricarichi o modifichi manualmente)');
    });

    /* ====================== STORICO PRATICHE (LOCALE) ======================= */
    const PRACTICES_KEY = 'acea_portale_pratiche_v1';
    const historyCountEl = document.getElementById('historyCount');
    function getPractices(){
      try{ return JSON.parse(localStorage.getItem(PRACTICES_KEY) || '[]'); }
      catch{ return []; }
    }
    function setPractices(arr){
      localStorage.setItem(PRACTICES_KEY, JSON.stringify(arr));
      updateHistoryCount();
    }
    function updateHistoryCount(){ historyCountEl.textContent = getPractices().length; }
    function toLocalDateTime(iso){
      const d = new Date(iso);
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yyyy = d.getFullYear();
      const hh = String(d.getHours()).padStart(2,'0');
      const mi = String(d.getMinutes()).padStart(2,'0');
      return `${dd}/${mm}/${yyyy} ${hh}:${mi}`;
    }
    function savePractice(channel, message){
      const fields = {};
      document.querySelectorAll('#wizardForm input, #wizardForm select').forEach(el => fields[el.id] = el.value);
      const tipo = fields['tipoCliente'];
      const nominativo = (tipo === 'privato') ? fields['nome'] : fields['azienda'];
      const practice = {
        id: Date.now().toString(36)+Math.random().toString(36).slice(2,7),
        created: new Date().toISOString(),
        channel,
        message,
        fields,
        tipoCliente: tipo,
        cliente: nominativo || '',
        codice: fields['codice'] || '',
        operazione: fields['tipoOp'] || '',
        indirizzoFornitura: resolvedFornituraAddress() || '',
        metodoPag: fields['metodoPag'] || '',
        iban: fields['iban'] || '',
        pod: fields['pod'] || '',
        pdr: fields['pdr'] || '',
        fornitoreUscenteLuce: fields['fornitoreUscenteLuce'] || '',
        fornitoreUscenteGas: fields['fornitoreUscenteGas'] || ''
      };
      const list = getPractices();
      list.unshift(practice);
      setPractices(list);
      return practice.id;
    }
    // Modal controls
    const modal = document.getElementById('historyModal');
    const tbody = document.getElementById('historyTbody');
    const searchInput = document.getElementById('historySearch');
    const historyHint = document.getElementById('historyHint');

    function renderHistory(){
      const q = (searchInput.value || '').toLowerCase();
      const list = getPractices();
      let shown = 0;
      tbody.innerHTML = '';
      list.forEach(p => {
        const hay = [
          p.cliente, p.operazione, p.indirizzoFornitura, p.codice, p.pod, p.pdr, p.metodoPag
        ].join(' ').toLowerCase();
        if(q && !hay.includes(q)) return;
        shown++;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${toLocalDateTime(p.created)}</td>
          <td><div><strong>${p.cliente || '-'}</strong></div><div class="muted">${p.codice || ''}</div></td>
          <td>${p.operazione || '-'}</td>
          <td>${p.indirizzoFornitura || '-'}</td>
          <td><span class="badge">${p.channel}</span></td>
          <td class="td-actions">
            <button type="button" class="link-btn" data-action="copy" data-id="${p.id}">Copia testo</button>
            <button type="button" class="link-btn" data-action="draft" data-id="${p.id}">Riprendi come bozza</button>
            <button type="button" class="link-btn" data-action="delete" data-id="${p.id}">Elimina</button>
          </td>`;
        tbody.appendChild(tr);
      });
      historyHint.textContent = shown ? `${shown} pratiche mostrate` : 'Nessuna pratica';
    }
    function openHistory(){
      renderHistory();
      modal.classList.add('show');
      modal.setAttribute('aria-hidden','false');
    }
    function closeHistory(){
      modal.classList.remove('show');
      modal.setAttribute('aria-hidden','true');
    }
    document.getElementById('btnOpenHistory').addEventListener('click', openHistory);
    document.getElementById('btnCloseHistory').addEventListener('click', closeHistory);
    document.getElementById('btnCloseBottom').addEventListener('click', closeHistory);
    modal.addEventListener('click', e => { if(e.target === modal) closeHistory(); });
    searchInput.addEventListener('input', renderHistory);

    // Delegazione azioni tabella
    tbody.addEventListener('click', async e => {
      const btn = e.target.closest('button[data-action]');
      if(!btn) return;
      const id = btn.getAttribute('data-id');
      const action = btn.getAttribute('data-action');
      const list = getPractices();
      const idx = list.findIndex(p => p.id === id);
      if(idx === -1) return;

      if(action === 'copy'){
        try{
          await navigator.clipboard.writeText(list[idx].message);
          alert('Testo pratica copiato negli appunti.');
        }catch{
          // fallback
          const ta = document.createElement('textarea');
          ta.value = list[idx].message; document.body.appendChild(ta);
          ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
          alert('Testo pratica copiato (fallback).');
        }
      }
      else if(action === 'draft'){
        // carica i campi come bozza
        const data = list[idx].fields || {};
        localStorage.setItem(DRAFT_KEY, JSON.stringify(data));
        loadDraftObj(data);
        closeHistory();
        show(0);
        saveStatus.textContent = 'Bozza caricata dallo storico';
        window.scrollTo({ top: 0, behavior:'smooth' });
      }
      else if(action === 'delete'){
        if(confirm('Eliminare questa pratica dallo storico?')){
          list.splice(idx,1);
          setPractices(list);
          renderHistory();
        }
      }
    });

    // Esporta CSV
    document.getElementById('btnExportCSV').addEventListener('click', () => {
      const list = getPractices();
      if(!list.length){ alert('Archivio vuoto.'); return; }
      const headers = ['id','created','channel','tipoCliente','cliente','codice','operazione','indirizzoFornitura','metodoPag','iban','pod','pdr','fornitoreUscenteLuce','fornitoreUscenteGas'];
      const rows = [headers.join(';')];
      list.forEach(p=>{
        const row = headers.map(h=>{
          let v = (p[h] ?? '').toString().replace(/[\r\n]+/g,' ').replace(/;/g, ',');
          return `"${v}"`;
        }).join(';');
        rows.push(row);
      });
      const blob = new Blob([rows.join('\n')], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      const now = new Date();
      const stamp = now.toISOString().replace(/[:.]/g,'-');
      a.download = `storico_pratiche_${stamp}.csv`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
    });

    // Svuota archivio
    document.getElementById('btnClearHistory').addEventListener('click', ()=>{
      if(confirm('Svuotare completamente lo storico pratiche?')){
        setPractices([]);
        renderHistory();
      }
    });

    /* ====================== INVIO (SALVA + WHATSAPP/MAIL) ======================= */
    document.getElementById('btnSendWhatsApp').onclick = () => {
      if(!validateAll()) return;
      const text = buildMessage();
      savePractice('whatsapp', text);
      window.open(`https://wa.me/393701357100?text=${encodeURIComponent(text)}`,'_blank');
    };
    document.getElementById('btnSendMail').onclick = () => {
      if(!validateAll()) return;
      const text = buildMessage();
      const tipo = document.getElementById('tipoCliente').value;
      const nominativo = (tipo === 'privato') ? document.getElementById('nome').value : document.getElementById('azienda').value;
      const subject = `Richiesta inserimento ${nominativo || 'contratto'}`;
      savePractice('mail', text);
      window.location.href = `mailto:mario.isernia@e2kdistribution.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(text)}`;
    };

    /* ====================== AVVIO ======================= */
    document.addEventListener('DOMContentLoaded', () => {
      updateHistoryCount();
      const raw = localStorage.getItem(DRAFT_KEY);
      if(raw){
        loadDraft();
      }else{
        const sel = document.getElementById('useSameAddress');
        if(sel){
          sel.selectedIndex = 0;
          sel.dispatchEvent(new Event('change'));
        }
      }
    });
  </script>
</body>
</html>
